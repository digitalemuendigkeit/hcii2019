---
title: "Spiral of Silence"
author: "Patrick Halbach, Andr√© Calero Valdez"
date: "12 Dezember 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Hmisc)
library(tidyr)
library(tidyverse)
library(haven)
library(sjlabelled)
library(psych)
library(data.table)
```

First we clean our SPSS output files. For this purpose we remove identifying information..
```{r data-cleaning}
raw <- read_sav("data/SpiralofSilence.sav")


# rename variables ---- 
codebook_filename <- "codebook.csv"

if(!file.exists(codebook_filename)){
  variable_names <- names(raw)
  label_names <- get_label(raw)

  codebook <- data.frame(variable_names, label_names)
  print("test")
  write_delim(codebook, path = codebook_filename, delim = ";")
} else {
  codebook <-read_delim(codebook_filename, delim=";")
}

  # Change variable labels to those from the codebook.csv
  names(raw) <- codebook$variable_names
  
  names(raw)
  

# select required variables ----
  raw[,c(-1:-10)] -> c_df
  
  c_df$filtervar <- ifelse(is.na(c_df$topSmokedet_contra | c_df$topSmokedet_pro), NA, 1)
  
  c_df %>% filter(!is.na(filtervar)) -> data
  
  data
  # factors and ordinal data
  data$Age <- as.numeric(data$Age)
  data$Gender <- as.factor(data$Gender)
  
  
  # Function to convert factor variabls from surveymonkey spss file to usable factors
  convert_to_factor <- function(x, ordered = T, rev = F) {
      result <- factor(x, labels = get_labels(x), 
                       levels = 1:length(get_labels(x)), ordered = ordered )
      if(rev) {
        result <- fct_rev(result)
      }
      result
  }
  
  
  data <- data %>% mutate_at(vars(starts_with("Big5")), convert_to_factor, rev = T )
  data <- data %>% mutate_at(vars(starts_with("fb_")), convert_to_factor, rev = T )  
  
  
  # filter incomplete responses
  
  codebook[22:27,]$label_names
  
  # calculate factors and scales
  
  key_list <- list(b5_o = list("big5_o1", "big5_o2"),
                   b5_e = list("-big5_e1", "big5_e2"),
                   b5_n = list("-big5_n1", "big5_n2"))
  
  scores <- psych::scoreItems(key_list, data, min = 1, max = 6, impute = "mean")  
  
  scores
  
  data <- data %>% cbind(scores$scores) 
  
  data %>% select(-starts_with("big5"))
  

  data <- data %>% mutate_if(~ any(is.na(.x)),~ if_else(is.na(.x),0,as.numeric(.x)))
  data <- data %>% mutate_at(vars(starts_with("top")), as.factor)

```

GGPlots
```{r plotting}

SMdata <- data[,c(3:8)]

### Sum the data using apply & use this for beautiful barplot
sumdata <- data.frame(value=apply(SMdata,2,sum))
sumdata$key <- c("Facebook", "Twitter", "Instagram","Google Plus","Snapchat","Youtube")

SMPlot <- ggplot(data=sumdata, aes(x=reorder(key, -value), y=value, fill=key)) +
  geom_bar(stat="identity") +
  geom_text(aes(x=key,y=value, label=value),vjust=-1) +
  xlab("Social media service") +
  ylab("User count") +
  ylim(0,160) +
  theme_grey()

SMPlot + guides(fill=FALSE)

initialopinion <- data.frame(PublicToilets=data$topToilets_opinion,Foodtaxes=data$topFood_opinion,Ronaldo=data$topRonaldo_opinion,Smokedetectors=data$topSmokedet_opinion)

opinionsums <- data.frame(sum(initialopinion$PublicToilets), sum(initialopinion$Foodtaxes))

initialopinion$row <- seq_len(nrow(initialopinion))
initialopinion <- melt(initialopinion, id.vars = "row")
initialopinion$value <- factor(initialopinion$value)
ggplot(initialopinion, aes(x = variable, fill=value)) + 
  geom_bar() +
#  geom_text(aes(x=variable,y=value, label=value),vjust=-1) +
#  scale_y_continuous() +
  #xlab("\nTopic") +
  #ylab("Opinion\n") +
 # guides(fill = FALSE) +
  theme_grey()

```