---
title: "Spiral of Silence"
author: "Patrick Halbach, André Calero Valdez"
date: "12 Dezember 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Hmisc)
library(tidyr)
library(tidyverse)
library(haven)
library(sjlabelled)
library(psych)
library(data.table)
library(hcictools)
```

First we clean our SPSS output files. For this purpose we remove identifying information..
```{r data-cleaning}
raw <- read_sav("data/SpiralofSilence.sav")


# rename variables ---- 
codebook_filename <- "codebook.csv"

if(!file.exists(codebook_filename)){
  variable_names <- names(raw)
  label_names <- get_label(raw)

  codebook <- data.frame(variable_names, label_names)
  print("test")
  write_delim(codebook, path = codebook_filename, delim = ";")
} else {
  codebook <-read_delim(codebook_filename, delim=";")
}

  # Change variable labels to those from the codebook.csv
  names(raw) <- codebook$variable_names
  
  names(raw)
  

# select required variables ----
  raw[,c(-1:-10)] -> c_df
  
  c_df$filtervar <- ifelse(is.na(c_df$topSmokedet_contra | c_df$topSmokedet_pro), NA, 1)
  
  c_df %>% filter(!is.na(filtervar)) -> data
  
  data
  # factors and ordinal data
  data$Age <- as.numeric(data$Age)
  data$Gender <- as.factor(data$Gender)
  
  
  # Function to convert factor variabls from surveymonkey spss file to usable factors
  convert_to_factor <- function(x, ordered = T, rev = F) {
      result <- factor(x, labels = get_labels(x), 
                       levels = 1:length(get_labels(x)), ordered = ordered )
      if(rev) {
        result <- fct_rev(result)
      }
      result
  }
  
  
  data <- data %>% mutate_at(vars(starts_with("Big5")), convert_to_factor, rev = T )
  data <- data %>% mutate_at(vars(starts_with("fb_")), convert_to_factor, rev = T )  
  
  
  # filter incomplete responses
  
  codebook[22:27,]$label_names
  
  # calculate factors and scales
  
  key_list <- list(b5_o = list("big5_o1", "big5_o2"),
                   b5_e = list("-big5_e1", "big5_e2"),
                   b5_n = list("-big5_n1", "big5_n2"))
  
  scores <- psych::scoreItems(key_list, data, min = 1, max = 6, impute = "mean")  
  
  scores
  
  data <- data %>% cbind(scores$scores) 
  
  data %>% select(-starts_with("big5"))
  

  data <- data %>% mutate_if(~ any(is.na(.x)),~ if_else(is.na(.x),0,as.numeric(.x)))
  data <- data %>% mutate_at(vars(starts_with("top")), as.factor)

```

GGPlot for Social Media Usage
```{r plot-smuse}

SMdata <- data[,c(3:8)]

### Sum the data using apply & use this for beautiful barplot
sumdata <- data.frame(value=apply(SMdata,2,sum))
sumdata$key <- c("Facebook", "Twitter", "Instagram","Google Plus","Snapchat","Youtube")

SMPlot <- ggplot(data=sumdata, aes(x=reorder(key, -value), y=value, fill=reorder(key, -value))) +
  geom_bar(stat="identity") +
  geom_text(aes(x=key,y=value, label=value),vjust=-1) +
  xlab("Social media service") +
  ylab("User count") +
  ylim(0,160) +
  scale_fill_viridis_d() +
  theme_grey()

SMPlot + guides(fill=FALSE)

ggsave("SocialMediaUse.pdf",width = 7, height = 4)

```


Plotting the initial opinion
```{r plot-initopinion}

rwthcolors <- hcictools::rwth.colorpalette()
agreement_palette <- colorRampPalette(c(rwthcolors$red,"white",rwthcolors$green))

# Actual code for building the stacked barplot without working text labels
initOp <- data.frame(PublicToilets=data$topToilets_opinion,Foodtaxes=data$topFood_opinion,
                     Ronaldo=data$topRonaldo_opinion,Smokedetectors=data$topSmokedet_opinion)

initOp$row <- seq_len(nrow(initOp))
initOp <- melt(initOp, id.vars = "row")
initOp$value <- factor(initOp$value)

ggplot(initOp, aes(x = variable, fill=value)) + 
  geom_bar() +
  scale_fill_manual(values=agreement_palette(2)) +
  theme_grey()


# Crappy Code, but works for now for the stacked barplot with labels
dfop <- data.frame(PublicToilets=data$topToilets_opinion,Foodtaxes=data$topFood_opinion,
                     Ronaldo=data$topRonaldo_opinion,Smokedetectors=data$topSmokedet_opinion)

df <- data.frame(x = factor(c("1. Public Toilets", "2. Food Taxes", "1. Public Toilets", "2. Food Taxes", "3. Ronaldo", "4. Smoke detectors", "3. Ronaldo", "4. Smoke detectors")), y = c(sum(dfop$PublicToilets == 1), sum(dfop$Foodtaxes == 1),  sum(dfop$PublicToilets == 2), sum(dfop$Foodtaxes == 2), sum(dfop$Ronaldo == 1), sum(dfop$Smokedetectors == 1), sum(dfop$Ronaldo == 2),  sum(dfop$Smokedetectors == 2)),Agreement = c("pro", "pro", "contra", "contra", "pro", "pro", "contra", "contra"))
  
ggplot(data = df, aes(x, y, group = Agreement)) +
  geom_col(aes(fill = Agreement)) +
  geom_text(aes(label = y), position = position_stack(vjust = 0.5)) +
  labs(x="Topic", y="Count") +
  scale_fill_manual(values=agreement_palette(2)) +
  theme_grey()

ggsave("InitialOpinion.pdf", width = 7, height = 4)
```


Plotting Mean Comparisons
```{r plot-further}
variable_set <- c(
            "FB_schon_gehört",
            "FB_glaube_existiert",
            "FB_interessante_Beiträge",
            "FB_betrifft_persönlich",
            "FB_Problem",
            "FB_bewusstes_Vorgehen"
            )

label_set <- c(
              "sg",
              "existier",
              "interessant",
              "Betrifft per",
              "problem",
              "bewusst"
              )

make_variable_labels <- function(x) {
  factor(x, levels = variable_set,
            labels = label_set
            )
}

data %>% 
  dplyr::select(variable_set) %>% 
  map_df(as.numeric) %>% 
  psych::describe() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  mutate (variablename = make_variable_labels(rowname)) -> plot_data
```