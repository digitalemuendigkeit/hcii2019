---
title: "Bubble Trouble: Strageties something something Filterbubble Awareness"
author: "Laura Burbach, Patrick Halbach, Martina Ziefle, André Calero Valdez"
date: "12 12 2018"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
    collapsed: false
    df_print: paged
    dev: png
    self_contained: true
    number_sections: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sjlabelled)
library(sjPlot)
library(forcats)
library(corrplot)
library(hcictools)
library(ggplot2)
library(likert)

source("../survemonky_helper.R")
```

# Data Cleaning
First we clean our SPSS output files. For this purpose we remove identifying information..

```{r data-cleaning, include=FALSE}
raw <- haven::read_sav("data/raw.sav", encoding = "UTF-8")


# rename variables ---- 
codebook_filename <- "codebook.csv"

# If file does not exist
if(!file.exists(codebook_filename)){
  variable_names <- names(raw)
  label_names <- get_label(raw)

  codebook <- data.frame(variable_names, label_names)
  print("test")
  write_delim(codebook, path = codebook_filename, delim = ";")
} else {
  codebook <-read_delim(codebook_filename, delim=";")
}

# Change variable labels to those from the codebook.csv
names(raw) <- codebook$variable_names

names(raw)

# select required variables ----
raw[,c(-1:-10)] %>% select(-starts_with("p0")) -> data

# factors and ordinal data
data$age <- as.numeric(data$age)
data$gender

data$education <- factor(data$education, 
                         labels=get_labels(data$education), 
                         level = 1:7, ordered = T)


data <- data %>% mutate_at(vars(starts_with("big5")), srvmky_convert_factor, rev = T )
#data <- data %>% mutate_at(vars(starts_with("FB_")), srvmky_convert_factor, rev = T ) 
data <- data %>% mutate_at(vars(starts_with("FBV_")), srvmky_convert_factor, rev = T )

# filter incomplete responses
# data %>% filter(rowSums(is.na(data)) < 5)


codebook[16:25,]$label_names
# calculate factors and scales


```


## Calculation of scales


### Calculate Big 5
```{r scale_big5}

# create big 5 factors ----  
key_list_big5 <- list(b5_n = list("-big5_04", "big5_09"),
                      b5_e = list("-big5_01", "big5_06"),
                      b5_o = list("big5_05", "big5_10"),
                      b5_a = list("big5_02", "-big5_07"),
                      b5_c = list("-big5_03", "big5_08"))

scores <- psych::scoreItems(key_list_big5, data, min = 1, max = 6, impute = "mean")  

scores

data <- data %>% cbind(scores$scores) 

#data <- data %>% select(-starts_with("big5"))


```


### Facebook
```{r scale_facebook}

key_list_FB <- list(FB = list("FB_schon_gehört", "FB_glaube_existiert", "FB_betrifft_persönlich", "FB_Problem", "FB_interessante_Beiträge", "FB_bewusstes_Vorgehen"))

scores <- psych::scoreItems(key_list_FB, data, min = 1, max = 6, impute = "mean")  

scores

# Attach scale
data <- data %>% cbind(scores$scores) 

# Remove items
# data <- data %>% select(-starts_with("FB_"))



```


### Avoidance Strategies
```{r scale_fbv}

key_list_FBV <-
  list(
  FBV = list(
  "FBV_Loeschen",
  "FBV_Incognito",
  "FBV_Vielfalt_erzwingen",
  "FBV_Explorer",
  "FBV_deabonnieren"
  )
  )

scores <- psych::scoreItems(key_list_FBV, data, min = 1, max = 6, impute = "mean")

scores

data <- data %>% cbind(scores$scores) 

# data <- data %>% select(-starts_with("FBV_"))

data

```

# Analysis
Here we compute the results

## Descriptive Statistics
```{r descriptive}
psych::describe(data)
```

## Reasons to use Facebook
Here we look at the reasons to use Facebook
```{r XXX}

#barplot(table(data$FB_schon_gehört, data$FB_glaube_existiert, data$FB_betrifft_persönlich, data$FB_Problem, data$FB_interessante_Beiträge, data$FB_bewusstes_Vorgehen),col=c("black","green","red"),
#ylab="Anzahl Personen")


library(purrr)

variable_set <- c(
            "FB_schon_gehört",
            "FB_glaube_existiert",
            "FB_interessante_Beiträge",
            "FB_betrifft_persönlich",
            "FB_Problem",
            "FB_bewusstes_Vorgehen"
            )

label_set <- c(
              "heard about the filter bubbles",
              "believe the filter bubble exists",
              "filter bubble displays only interesting posts",
              "filter bubble affects me personally",
              "filer bubble is a problem",
              "take action against the filter bubble"
              )

make_variable_labels <- function(x) {
  factor(x, levels = variable_set,
            labels = label_set
            )
}

data %>% 
  dplyr::select(variable_set) %>% 
  map_df(as.numeric) %>% 
  psych::describe() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  mutate (variablename = make_variable_labels(rowname)) -> plot_data

library(hcictools)
library(RColorBrewer)

rwthcolors <- hcictools::rwth.colorpalette()

agreement_palette <- colorRampPalette(c(rwthcolors$red,"white", rwthcolors$green))

plot_data %>% 
  ggplot() +
  aes(x=reorder(variablename, mean), y = mean, fill = reorder(variablename, mean), 
      ymin = mean - se * 1.96 , ymax = mean + se * 1.96) +
  scale_y_continuous(limits = c(0,5), labels = 1:6) +
  geom_col() +
  geom_errorbar(width = 0.3) +
  labs(x="Variables", y="Mean of agreement (1-6)", 
       title="Most user know the pheonomenon filter bubble",
       subtitle = "Different measures of filter bubble awareness",
       caption = "Errorbars denote the 95% confidence intervall of the mean.") +
  guides(fill = FALSE) +
  coord_flip() +
  #scale_fill_brewer(palette = "Spectral") + 
  scale_fill_manual(values=agreement_palette(6)) +
  theme_bw() + 
  NULL


agreement_english <- function(x) {
  factor(x, levels = c("Stimme gar nicht zu",
                            "Stimme nicht zu",
                            "Stimme eher nicht zu",
                            "Stimme eher zu",
                            "Stimme zu",
                            "Stimme vollkommen zu"),
              labels = c("completely disagree",
                         "disagree",
                         "rather disagree",
                         "rather agree",
                         "agree",
                         "completely agree"))
}



data %>% 
  dplyr::select(variable_set) %>% 
 magrittr::set_colnames(label_set) %>%
  mutate_all(agreement_english) %>% 
  likert() %>% plot(low.color = rwthcolors$red, high.color = rwthcolors$green) + 
  labs(title="Test")

```

### Gender Differences for Personality
```{r analysis}
## means

formatting_option <- "pandoc" # or "latex"

apa_ttest <- function(formula, data, type = formatting_option, alpha = 0.05) {
  hypo <- t.test(formula, data = data)

  stat_output <-  apastats::describe.ttest(hypo, type = type)
  
  if(hypo$p.value < alpha){
    msg <- paste0("Es gibt einen signifikanten Unterschied (",stat_output,").")
  } else {
    msg <- paste0("Es gibt keinen signifikanten Unterschied (",stat_output,").")
  }
  
  msg
}


  data %>% apa_ttest(formula = b5_n ~ gender)
  data %>% apa_ttest(formula = b5_o ~ gender)
  data %>% apa_ttest(formula = b5_c ~ gender)
  data %>% apa_ttest(formula = b5_e ~ gender)
  data %>% apa_ttest(formula = b5_a ~ gender)

```

Unterschied: zwischen Geschlechtern für Offenheit: `r data %>% apa_ttest(formula = b5_o ~ gender)`

## ANOVA Test

```{r anova}

jmv::ttestIS(data, (c("b5_n", "b5_e", "b5_c")), group = "gender", welchs = T, norm = T)

result <- jmv::ANOVA(data = data, 
                     dep = c("b5_o"), 
                     factors = "education", 
                     emmPlots = T, 
                     emMeans = list("education"))


model <- aov(data = data, b5_n ~ education)
m<- anova(model)



data %>% select(starts_with("b5"), "FBV", starts_with("fb")) %>% select(1:10) %>% 
  mutate_if(is.ordered, as.numeric) %>% 
  hcictools::cor.matrix.plot()


data %>% select(starts_with("b5"), "FBV", starts_with("fb")) %>% select(1:10) %>% 
  mutate_if(is.ordered, as.numeric) -> corrdata

cor.test(data = corrdata, ~ b5_n + fb_tablet) -> hypo_c1

apastats::describe.r(hypo_c1, type="latex")

lm(data = corrdata, formula = fb_tablet ~ b5_n) -> hypo_lm1
lm(data = corrdata, formula = fb_tablet ~ b5_n + fb_smartphone) -> hypo_lm2

anova(hypo_lm1, hypo_lm2)

apastats::describe.glm(hypo_lm2, type="latex")

psych::alpha(corrdata, list("b5_o", "b5_n", "b5_c"))

#library(likert)
#data %>% select(6:15) %>% likert() %>% plot()

```



### age



### Action against filter bubble 


### wishes regarding facebook



## correlations

### 1





